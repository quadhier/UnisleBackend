<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="content-type" charset="UTF-8">
    <link href="css/article/styles.css" rel="stylesheet" type="text/css"/>
    <link href="css/animate.min.css" rel="stylesheet" type="text/css"/>
    <script src="js/jquery-1.8.3.min.js"></script>
    <script src="js/jquery-ui-1.8.10.custom.min.js"></script>
    <script src="js/article/article.js"></script>
    <script src="js/jPages.js"></script>
    <script>

        $(document).unbind("ready").bind("ready", function () {

            //变量定义区
            var userid;
            var nickname;
            var articleid = innerURL.split('?')[1].split('&')[0].split('=')[1];
            var authorid = innerURL.split('?')[1].split('&')[1].split('=')[1];
            var articleEntity;
            var commentList;
            //初始化执行区
            $.ajax({
                type: "GET",
                url: "self",
                dataType: "json",
                data: {},
                async: false,
                timeout: 5000,
                cache: false,
                success: function (res) {
                    if (res.result == 'LOGINERROR') {
                        window.reload('login.html');
                    }
                    if (res.result != 'SUCCESS') {
                        alert('获取用户个人信息失败，请刷新或重新登陆。')
                    }
                    var userdata = res.data;
                    userid = userdata.userid;
                    nickname = userdata.nickname;
                }

            });//获得用户信息
            $.ajax({
                type: "GET",
                url: "forum/article/content",
                dataType: "json",
                data: {
                    'articleid': articleid
                },
                timeout: 5000,
                async: false,
                cache: false,
                success: function (res) {
                    if (res.result == 'LOGINERROR') {
                        window.reload('login.html');
                    }
                    if (res.result != 'SUCCESS') {
                        alert('获取文章信息失败，请刷新。')
                    }
                    articleEntity = res.data;
                }

            });//获得文章信息
            $.ajax({
                type: "GET",
                url: "forum/article/comment",
                dataType: "json",
                data: {
                    'articleid': articleid
                },
                timeout: 5000,
                async: false,
                cache: false,
                success: function (res) {
                    if (res.result == 'LOGINERROR') {
                        window.reload('login.html');
                    }
                    if (res.result != 'SUCCESS') {
                        alert('获取评论列表失败，请刷新。')
                    }
                    commentList = res.data;
                }

            });//获得评论实体列表
            $.ajax({
                type: "GET",
                url: "forum/userinfo",
                dataType: "json",
                data: {
                    'userid': authorid
                },
                timeout: 3000,
                success: function (res) {
                    var authorData = res.data;
                    $('#authorName').text(authorData.nickname);
                    $('#authorLevel').text('作者等级：' + authorData.rank);
                    $('#authorExp').text('作者经验：' + authorData.exp);
                }
            });//获得作者信息并修改作者栏
            {
                var publictime = new Date(parseInt(articleEntity.publicdatetime)).toLocaleString().replace(/:d{1,2}$/, ' ');
                $('#articleTitleSpan').text(articleEntity.title);
                $('.articleContent').html('<p>' + articleEntity.content + '</p>');
                $('#articlePublicTimeSpan').text('发表时间:' + publictime);
            }//修改文章栏
            {
                $(".articleBackIcon").hide();
                $(".articleContentDiv").hover(function () {
                    $(".articleBackIcon").show(500);
                }, function () {
                    $(".articleBackIcon").hide(500);
                });
            }//设置返回按钮
            {
                $('.commentDiv').remove();
                var commentNum = commentList.length;
                $('#articleCommentNumberSpan').text('评论:' + commentNum);
                for (var i = 0; i < commentNum; i++) {
                    var commentEntity = commentList[i];
                    var commenter;
                    var commentContent = commentEntity.content;
                    var commentTime = new Date(parseInt(commentEntity.articlecommentEntityPK.publicdatetime)).toLocaleString().replace(/:d{1,2}$/, ' ');
                    $.ajax({
                        type: "GET",
                        url: "forum/userinfo",
                        dataType: "json",
                        async: false,
                        data: {
                            'userid': commentEntity.articlecommentEntityPK.userid
                        },
                        timeout: 3000,
                        success: function (res) {
                            commenter = res.data;
                        }
                    });

                    $('#itemContainer').append(
                        '<div id = "comment_NO."' + i + ' class="commentDiv">' +
                        '<div class="commentDivTop">' +
                        '<div class="commenter"><span>' + commenter.nickname + '</span></div>' +
                        '<div class="floor"><span>#' + (i + 1) + '</span></div>' +
                        '</div>' +
                        '<div class="commentContent">' +
                        '<p>' + commentContent + '</p>' +
                        '</div>' +
                        '<div class="commentTime">' +
                        '<span>' + commentTime + '</span>' +
                        '</div>' +
                        '</div>'
                    );
                }
            }//加载评论列表
            $(function () {
                $("div.holder").jPages({
                    containerID: "itemContainer",
                    previous: "←",
                    next: "→",
                    perPage: 5
                });
            });//设置页码栏
            //回调方法绑定区
            $('#publishComment').click(function () {
                var content = $('.comment_input').val();
                //$('.comment_input').val("");
                if (content.length == 0) {
                    alert("回复不能为空")
                    return;
                }
                $.ajax({
                    type: "POST",
                    url: "forum/article/comment",
                    dataType: "json",
                    data: {
                        'articleid': articleid,
                        'content': content
                    },
                    timeout: 10000,
                    success: function (res) {
                        if (res.result == 'LOGINERROR') {
                            window.reload('login.html');
                        }
                        if (res.result != 'SUCCESS') {
                            alert('发送失败。')
                        }
                        //发送通知：文章评论
                        $.ajax({
                            type:'POST',
                            url:'notice/sendNotice',
                            dataType:'json',
                            data:{
                                'receiver':authorid,
                                'type':'articlecommented',
                                'content':content+' (Re:'+articleEntity.title+')'
                            },
                            timeout:10000
                        });
                        var newURL = 'article.html?' + 'id=' + articleid + '&author=' + authorid;
                        //window.location.replace(newURL);
                        simURLReplace(newURL);
                    }

                });
            });
            function encodeUTF8(str) {
                var temp = "", rs = "";
                for (var i = 0, len = str.length; i < len; i++) {
                    temp = str.charCodeAt(i).toString(16);
                    rs += "\\u" + new Array(5 - temp.length).join("0") + temp;
                }
                return rs;
            }

            $(".articleBackIcon").unbind("click");
            $(".articleBackIcon").click(function () {
                forumFirst = false;
                var boardname = articleEntity.boardname;
                var boardcount;

                {
                    if (boardname == '校园生活')
                        boardcount = 1;
                    else if (boardname == '时事热点')
                        boardcount = 2;
                    else if (boardname == '音乐天地')
                        boardcount = 3;
                    else if (boardname == '影视先锋')
                        boardcount = 4;
                    else if (boardname == '动漫乐园')
                        boardcount = 5;
                    else if (boardname == '时尚前沿')
                        boardcount = 6;
                    else if (boardname == '职场经验')
                        boardcount = 7;
                    else if (boardname == '专业交流')
                        boardcount = 8;
                    else if (boardname == '情感分享')
                        boardcount = 9;
                    else if (boardname == '游戏世界')
                        boardcount = 10;
                }
                var oldURL = 'board.html?board=' + boardcount + '&theme=' + encodeUTF8(articleEntity.themename);

                //window.location.replace(oldURL);
                simURLReplace(oldURL);
                //window.history.back(-1);
            })

        });
    </script>
    <title>Article</title>
</head>

<body>
<!--<img id="bg" src="images/bg.jpg" rel="background">-->
<div class="mainContainer">
    <!--楼主信息-->
    <div class="leftContainer">
        <div class="imgDiv"></div>
        <hr/>
        <div class="userInfo">
            <p id="authorName" class="pName">GoBang</p>
            <img id="sexImg" height="20px" src="images/article/male.png"/>
            <p id="authorLevel" class="pContent">作者等级：</p>
            <p id="authorExp" class="pContent">作者经验：</p>
        </div>
    </div>
    <!--文章及评论-->
    <div class="rightContainer">
        <div class="articleContentDiv">
            <div class="articleBackIcon">
                <img src="images/article/back.jpg" style="width:100%;height:100%"/>
            </div>
            <div class="articleTitle">
                <span id="articleTitleSpan">The Maiden lay</span>
            </div>

            <div class="articleContent">
                <p> The Maiden lay athwart the Warrior, her arms widespread as if to embrace him. The Mother seemed
                    almost to shudder as the flames came licking up her face. A longsword had been thrust through her
                    heart, and its leather grip was alive with flame. The Father was on the bottom, the first to fall.
                    Davos watched the hand of the Stranger writhe and curl as the fingers blackened and fell away one by
                    one, reduced to so much glowing charcoal. Nearby, Lord Celtigar coughed fitfully and covered his
                    wrinkled face with a square of linen embroidered in red crabs. The Myrmen swapped jokes as they
                    enjoyed the warmth of the fire, but young Lord Bar Emmon had turned a splotchy grey, and Lord
                    Velaryon was watching the king rather than the conflagration. Davos would have given much to know
                    what he was thinking, but one such as Velaryon would never confide in him. The Lord of the Tides was
                    of the blood of ancient Valyria, and his House had thrice provided brides for Targaryen princes;
                    Davos Seaworth stank of fish and onions. It was the same with the other lordlings. He could trust
                    none of them, nor would they ever include him in their private councils. They scorned his sons as
                    well. My grandsons will joust with theirs, though, and one day their blood may wed with mine. In
                    time my little black</p>
            </div>

            <div class="articleAbout">
                <div class="releaseTime"><span id="articlePublicTimeSpan">发表时间：2017-7-14 11:24</span></div>
                <div class="commentNun"><span id="articleCommentNumberSpan">评论：666</span></div>
            </div>
        </div>
        <!--撰写评论-->
        <div class="commentWrite">
            <p>发表评论</p>
            <textarea class="comment_input"></textarea>
            <div class="bottomDiv">
                <div id="publishComment" class="Btn"><span>回复</span></div>
            </div>
        </div>

        <div class="commentContainer">
            <div id="container" class="clearfix">
                <!--! end of #sidebar -->
                <div id="content" class="defaults">
                    <!-- navigation holder -->
                    <!--<div class="holder">-->
                    <!--</div>-->
                    <!-- item container -->
                    <ul id="itemContainer">
                        <!--
                        <div class="commentDiv">
                            <div class="commentDivTop">
                                <div class="commenter"><span>Gobang</span></div>
                                <div class="floor"><span>#1</span></div>
                            </div>
                            <div class="commentContent">
                                <p>He could trust none of them, nor would they ever include him in their private
                                    councils. They scor ned his sons as well. My grandsons will joust with theirs,
                                    though, and one day their blood may wed with mine. In time my little black</p>
                            </div>
                            <div class="commentTime">
                                <span>2017-7-14 11:24</span>
                            </div>
                        </div>
                        -->

                    </ul>
                    <!-- navigation holder -->
                    <div class="holder">
                    </div>
                </div>
                <!--! end of #content -->
            </div>

        </div>

        <div class="fillDiv"></div>
    </div>
</div>

</body>
</html>