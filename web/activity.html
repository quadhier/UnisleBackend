<!DOCTYPE html>
<html>
<head>
    <title>Activity</title>

    <META HTTP-EQUIV="pragma" CONTENT="no-cache">
    <META HTTP-EQUIV="Cache-Control" CONTENT="no-cache, must-revalidate">
    <META HTTP-EQUIV="expires" CONTENT="0">

    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link href="resources/css/jquery-ui-themes.css" type="text/css" rel="stylesheet"/>
    <link href="resources/css/axure_rp_page.css" type="text/css" rel="stylesheet"/>
    <link href="data/styles.css" type="text/css" rel="stylesheet"/>
    <link href="files/activity/styles.css" type="text/css" rel="stylesheet"/>
    <script src="resources/scripts/jquery-1.7.1.min.js"></script>
    <script src="resources/scripts/jquery-ui-1.8.10.custom.min.js"></script>
    <script src="resources/scripts/prototypePre.js"></script>
    <script src="data/document.js"></script>
    <script src="resources/scripts/prototypePost.js"></script>
    <script src="files/activity/data.js"></script>
    <script type="text/javascript">
        $axure.utils.getTransparentGifPath = function () {
            return 'resources/images/transparent.gif';
        };
        $axure.utils.getOtherPath = function () {
            return 'resources/Other.html';
        };
        $axure.utils.getReloadPath = function () {
            return 'resources/reload.html';
        };

        $(document).ready(function () {

            // 储存用户名
            var userName;

            /*
            *
            * 加载个人信息
            *
            * */

            $.ajax({
                type: "GET",
                url: "self",
                dataType: "json",
                data:{},
                async:false,
                timeout:5000,
                cache:false,
                beforeSend: function() {

                },

                error: function() {

                },

                success: function (res) {
                    //alert(res);
                    //alert(res.nickname);
                    //alert(res.department);

                    if(res.sex === 'male')
                        $("#u237_img").src = "images/activity/u237.png";
                    else
                        $("#u237_img").src = "images/activity/u238.png";
                    $("#cache5").text(res.nickname);
                    $("#cache7").text(res.department + "-" + res.grade + "级");
                    userName = res.nickname;
                }

            });

            /*
            *
            * 绑定发布动态的事件
            *
            * */

            $("#u271").click(function(){
                if($("#u245_input").val() !== "") {
                    $.ajax({
                        type: "POST",
                        url: "activity",
                        dataType: "json",
                        contentType: "application/json",
                        data:JSON.stringify({
                            "shieldIDList": null,
                            "content": $("#u245_input").val(),
                            "attachment": null
                        }),
                        //async:false,
                        timeout:5000,
                        cache:false,
                        beforeSend: function() {

                        },

                        error: function() {

                        },

                        success: function (activityid) {

                            var nowDate = new Date();

                            $("#u246").prepend("<div id='" + activityid  + "' class='container'>" +
                                "<hr style='top: 28px'/>" +
                                "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                "<div class='subRight'><p class='pSmall'>" + nowDate.toLocaleString() + "</p></div>" +
                                "<div class='divcenter'>" +
                                "<p class='pContent'>" + $("#u245_input").val() + "</p>" +
                                "</div>" +
                                "<hr style='top: 20px'/>" +
                                "<div class='btnDiv'>" +
                                "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                "<div class='good'><img class='goodImg' src='images/activity/good.png'></div>" +
                                "<p class='pGoodNum'>" + "<span>0</span>" + "人觉得很赞</p>" +
                                "</div>" +
                                "<div class='commentDiv'></div>" +
                                "<div class='writeCom'>" +
                                "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                "</div>");
                            $("#u245_input").val("");

                        }
                    });


                }
            });

            /*
            *
            * 加载动态并设置滚动时加载
            *
            * */
            $.ajax({
                type: "GET",

                //服务端url
                url: "activity/all/isfirst",
                dataType: "json",
                data: {
                    "lastTime": null,
                    "view": "self"
                },
                async: false,                           //可能会使得效率下降
                timeout: 5000,
                cache: false,
                beforeSend: function () {
                    //加载中...
                },
                error: function () {

                },
                //以下函数获取服务端传递给客户端的json格式数据
                success: function (res) {

                    if (res.tag === true) {
                        var userName = res.userName;
                        var activity = res.activity;
                        var comments = res.comments;
                        var commenters = res.commenters;
                        var pro = res.pro;


                        //设置赞图标的显示格式
                        var proDiv;
                        if(pro === true) {
                            proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                        } else {
                            proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                        }

                        var commentDisplay = "<div class='commentDiv'>";

                        // 组成评论的展示字符串
                        for (i in comments) {
                            commentDisplay = commentDisplay +
                                "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                "<p class='pComment'>" + comments[i].content + "</p>";
                        }
                        commentDisplay = commentDisplay + "</div>";

                        var pubDate = new Date(activity.publicdatetime);

                        $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                            "<hr style='top: 28px'/>" +
                            "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                            "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                            "<div class='divcenter'>" +
                            "<p class='pContent'>" + activity.content + "</p>" +
                            "</div>" +
                            "<hr style='top: 20px'/>" +
                            "<div class='btnDiv'>" +
                            "<div class='comment'><img src='images/activity/comment.png'></div>" +
                            "<div class='good'>" + proDiv + "</div>" +
                            "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                            "</div>" +
                            commentDisplay +
                            "<div class='writeCom'>" +
                            "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                            "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                            "</div>");

                    }

                }
            });


            for(var i = 0; i < 3; i++) {

                $.ajax({

                    type: "GET",

                    //服务端url
                    url: "activity/all/follow",
                    dataType: "json",
                    data: {
                        "lastTime": null,
                        "view": "self"
                    },
                    //async: false,                           //可能会使得效率下降
                    timeout: 5000,
                    cache: false,
                    beforeSend: function () {
                        //加载中...
                    },
                    error: function () {

                    },
                    //以下函数获取服务端传递给客户端的json格式数据
                    success: function (res) {

                        if (res.tag === true) {
                            var userName = res.userName;
                            var activity = res.activity;
                            var comments = res.comments;
                            var commenters = res.commenters;
                            var pro = res.pro;


                            //设置赞图标的显示格式
                            var proDiv;
                            if(pro === true) {
                                proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                            } else {
                                proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                            }

                            var commentDisplay = "<div class='commentDiv'>";

                            // 组成评论的展示字符串
                            for (i in comments) {
                                commentDisplay = commentDisplay +
                                    "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                    "<p class='pComment'>" + comments[i].content + "</p>";
                            }
                            commentDisplay = commentDisplay + "</div>";

                            var pubDate = new Date(activity.publicdatetime);

                            $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                                "<hr style='top: 28px'/>" +
                                "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                                "<div class='divcenter'>" +
                                "<p class='pContent'>" + activity.content + "</p>" +
                                "</div>" +
                                "<hr style='top: 20px'/>" +
                                "<div class='btnDiv'>" +
                                "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                "<div class='good'>" + proDiv + "</div>" +
                                "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                                "</div>" +
                                commentDisplay +
                                "<div class='writeCom'>" +
                                "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                "</div>");

                        }

                    }
                });
            }


            //var hasMore = true;
            $("#u227_state0").scroll(function () {

                var scrollTop = $(this).scrollTop();
                var scrollHeight = $(this).get(0).scrollHeight;
                var windowHeight = $(this).height();


                //如果有更多动态，则继续加载
                if (scrollTop / ( scrollHeight - windowHeight ) >= 0.8 && scrollTop / ( scrollHeight - windowHeight ) < 1) { //&& hasMore) {

                    $.ajax({

                        type: "GET",

                        //服务端url
                        url: "activity/all/follow",
                        dataType: "json",
                        data: {
                            "lastTime": null,
                            "view": "self"
                        },
                        //async: false,                           //可能会使得效率下降
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        //以下函数获取服务端传递给客户端的json格式数据
                        success: function (res) {

                            if (res.tag === true) {
                                var userName = res.userName;
                                var activity = res.activity;
                                var comments = res.comments;
                                var commenters = res.commenters;
                                var pro = res.pro;


                                //设置赞图标的显示格式
                                var proDiv;
                                if (pro === true) {
                                    proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                                } else {
                                    proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                                }


                                var commentDisplay = "<div class='commentDiv'>";

                                // 组成评论的展示字符串
                                for (i in comments) {
                                    commentDisplay = commentDisplay +
                                        "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                        "<p class='pComment'>" + comments[i].content + "</p>";
                                }
                                commentDisplay = commentDisplay + "</div>";

                                var pubDate = new Date(activity.publicdatetime);


                                //此处是滚动条到底部时候触发的事件，在这里写要加载的数据，或者是拉动滚动条的操作
                                $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                                    "<hr style='top: 28px'/>" +
                                    "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                    "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                                    "<div class='divcenter'>" +
                                    "<p class='pContent'>" + activity.content + "</p>" +
                                    "</div>" +
                                    "<hr style='top: 20px'/>" +
                                    "<div class='btnDiv'>" +
                                    "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                    "<div class='good'>" + proDiv + "</div>" +
                                    "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                                    "</div>" +
                                    commentDisplay +
                                    "<div class='writeCom'>" +
                                    "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                    "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                    "</div>");

                            } //else {
                              //  hasMore = false;
                              //}

                        }
                    });

                }
            });


            /*
            *
            * 为点赞图标绑定事件
            *
            * */

            $(".good").live("click", function () {

                var activityid = $(this).parents(".container").attr("id");
                // 如果未点赞，再次点击则点赞
                // 向后台同步数据，同时使显示的的点赞数加一
                if ($(this).find("img").attr('src') === 'images/activity/good.png') {
                    $(this).find("img").attr('src', "images/activity/good_selected.png");
                    //alert(activityid);
                    // 向后台传递点赞消息
                    $.ajax({
                        type: "POST",

                        //服务端url
                        url: "activity/pro",
                        dataType: "json",
                        data: {
                            "activityid": activityid
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        success: function (){
                            var pdiv = "#" + activityid;
                            var proNum = 1 + parseInt($(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text());
                            $(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text(proNum);

                        }
                    });

                }
                // 如果已经点赞，再次点击则取消点赞
                // 向后台同步数据，同时使显示的的点赞数减一
                else {
                    $(this).find("img").attr('src', "images/activity/good.png");
                    //alert(activityid);
                    // 向后台传递取消点赞的消息
                    $.ajax({
                        type: "POST",

                        //服务端url
                        url: "activity/pro/delete",
                        dataType: "json",
                        data: {
                            "activityid": activityid
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        success: function (res) {

//                            if(res.result === "ERROR")
//                                alert(res.reason);
//                            alert(res.result);

                            var pdiv = "#" + activityid;
                            var proNum = parseInt($(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text()) - 1;
                            $(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text(proNum);
                        }
                    });

                }
            });

            /*
            *
            *
            *  为评论图标绑定事件
            *
            * */
            $(".comment").live("click", function () {
                if ($(this).find("img").attr('src') === 'images/activity/comment.png') {
                    $(this).find("img").attr('src', "images/activity/comment_selected.png");

                }
                else {
                    $(this).find("img").attr('src', "images/activity/comment.png");
                }
                $(this).parents(".container").children(".writeCom").toggle(200);
            });


            /*
            *
            *
            *  为评论按钮绑定事件
            *
            * */

            $(".submit_comment").live("click", function() {


                //alert($(this).text());
                var inputEle = $(this).parents(".submitcontainer").siblings(".inputcontainer").children("input");
                var input = inputEle.val();
                //alert(input);
                if(input !== "") {

                    var activityid = $(this).parents(".container").attr("id");
                    //alert(activityid);
                    //alert(input);
                    $.ajax({
                        type: "POST",

                        // 服务端url
                        // 不用contentType指定编码则会出现乱码问题
                        url: "activity/comment",
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        dataType: "json",
                        data: {
                            "activityid": activityid,
                            "content": input
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {

                        },
                        error: function () {

                        },
                        success: function (res) {

//                            if (res.result === "ERROR")
//                                alert(res.reason);
//                            alert(res.result);

                            var pdiv = "#" + activityid;
                            $(pdiv).children(".commentDiv").append("<p class='pCommenter'>" + userName + "</p>" +
                                                                   "<p class='pComment'>" + input + "</p>");
                            inputEle.val("");
                            inputEle.parents(".container").children(".btnDiv").children(".comment").click();

                        }
                    });
                }
            });


        })
    </script>
</head>


<body>
<div id="base" class="">

    <!-- Unnamed (动态面板) -->
    <div id="u227" class="ax_default">
        <div id="u227_state0" class="panel_state" data-label="State1" style="">
            <div id="u227_state0_content" class="panel_state_content">

                <!-- Unnamed (动态面板) -->
                <div id="u228" class="ax_default">
                    <div id="u228_state0" class="panel_state" data-label="State1" style="">
                        <div id="u228_state0_content" class="panel_state_content">

                            <!-- Unnamed (矩形) -->
                            <div id="u229" class="ax_default">
                                <div id="u229_div" class=""></div>
                                <!-- Unnamed () -->
                                <div id="u230" class="text" style="display:none; visibility: hidden">
                                    <p><span></span></p>
                                </div>
                            </div>

                            <!-- Unnamed (图片) -->
                            <div id="u231" class="ax_default">
                                <img id="u231_img" class="img " src="images/activity/u231.png"/>
                                <!-- Unnamed () -->
                                <div id="u232" class="text" style="display:none; visibility: hidden">
                                    <p><span></span></p>
                                </div>
                            </div>

                            <!-- Unnamed (矩形) -->
                            <div id="u233" class="ax_default">
                                <div id="u233_div" class=""></div>
                                <!-- Unnamed () -->
                                <div id="u234" class="text">
                                    <p><span>Gobang</span></p>
                                </div>
                            </div>

                            <!-- Unnamed (矩形) -->
                            <div id="u235" class="ax_default">
                                <div id="u235_div" class=""></div>
                                <!-- Unnamed () -->
                                <div id="u236" class="text">
                                    <p><span>武汉大学-院系-年级</span></p>
                                </div>
                            </div>

                            <!-- Unnamed (形状) -->
                            <div id="u237" class="ax_default icon">
                                <img id="u237_img" class="img " src="images/activity/u237.png"/>
                                <!-- Unnamed () -->
                                <div id="u238" class="text" style="display:none; visibility: hidden">
                                    <p><span></span></p>
                                </div>
                            </div>

                            <!-- Unnamed (水平线) -->
                            <div id="u239" class="ax_default line">
                                <img id="u239_img" class="img " src="images/activity/u239.png"/>
                                <!-- Unnamed () -->
                                <div id="u240" class="text" style="display:none; visibility: hidden">
                                    <p><span></span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Unnamed (矩形) -->
                <div id="u241" class="ax_default">
                    <div id="u241_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u242" class="text" style="display:none; visibility: hidden">
                        <p><span></span></p>
                    </div>
                </div>

                <!-- Unnamed (矩形) -->
                <div id="u243" class="ax_default">
                    <div id="u243_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u244" class="text">
                        <p><span>请在此编辑并发布您的动态</span></p>
                    </div>
                </div>

                <!-- Unnamed (多行文本框) -->
                <div id="u245" class="ax_default text_area">
                    <textarea id="u245_input"></textarea>
                </div>

                <!-- Unnamed (动态面板) -->
                <div id="u246" class="ax_default">




                </div>

                <!-- Unnamed (矩形) -->
                <div id="u267" class="ax_default">
                    <div id="u267_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u268" class="text">
                        <p><span><br></span></p>
                        <p><span><br></span></p>
                        <p><span><br></span></p>
                        <p><span>公告</span></p>
                        <p><span><br></span></p>
                        <p><span>一些奇怪的超链接</span></p>
                        <p><span><br></span></p>
                        <p><span><br></span></p>
                        <p><span><br></span></p>
                        <p><span><br></span></p>
                    </div>
                </div>

                <!-- Unnamed (水平线) -->
                <div id="u269" class="ax_default line">
                    <img id="u269_img" class="img " src="images/activity/u239.png"/>
                    <!-- Unnamed () -->
                    <div id="u270" class="text" style="display:none; visibility: hidden">
                        <p><span></span></p>
                    </div>
                </div>

                <!-- .btn-default [submit btn] (矩形) -->
                <div id="u271" class="ax_default _btn-default" data-label=".btn-default [submit btn]">
                    <div id="u271_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u272" class="text">
                        <p><span>发布</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
