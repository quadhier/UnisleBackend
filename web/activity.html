<!DOCTYPE html>
<html>
<head>
    <title>Activity</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes"/>
    <link href="resources/css/jquery-ui-themes.css" type="text/css" rel="stylesheet"/>
    <link href="resources/css/axure_rp_page.css" type="text/css" rel="stylesheet"/>
    <link href="data/styles.css" type="text/css" rel="stylesheet"/>
    <link href="files/activity/styles.css" type="text/css" rel="stylesheet"/>
    <script src="resources/scripts/jquery-1.7.1.min.js"></script>
    <script src="resources/scripts/jquery-ui-1.8.10.custom.min.js"></script>
    <script src="resources/scripts/prototypePre.js"></script>
    <script src="data/document.js"></script>
    <script src="resources/scripts/prototypePost.js"></script>
    <script src="files/activity/data.js"></script>
    <script type="text/javascript">
        $axure.utils.getTransparentGifPath = function () {
            return 'resources/images/transparent.gif';
        };
        $axure.utils.getOtherPath = function () {
            return 'resources/Other.html';
        };
        $axure.utils.getReloadPath = function () {
            return 'resources/reload.html';
        };


        $(document).ready(function () {



            // 储存用户名
            var userName;

            /*
             *
             * 加载个人信息
             *
             * */

            $.ajax({
                type: "GET",
                url: "self",
                dataType: "json",
                data:{},
                async:false,
                timeout:5000,
                cache:false,
                beforeSend: function() {

                },

                error: function() {

                },

                success: function (res) {
                    //alert(res);
                    //alert(res.nickname);
                    //alert(res.department);

                    if(res.sex === 'male')
                        $("#u237_img").src = "images/activity/u237.png";
                    else
                        $("#u237_img").src = "images/activity/u238.png";
                    $("#cache5").text(res.nickname);
                    $("#cache7").text(res.department + "-" + res.grade + "级");
                    userName = res.nickname;
                }

            });

            /*
             *
             * 绑定发布动态的事件
             *
             * */

            $("#u271").click(function(){
                if($("#u245_input").val() !== "") {
                    $.ajax({
                        type: "POST",
                        url: "activity",
                        dataType: "json",
                        contentType: "application/json",
                        data:JSON.stringify({
                            "shieldIDList": null,
                            "content": $("#u245_input").val(),
                            "attachment": null
                        }),
                        //async:false,
                        timeout:5000,
                        cache:false,
                        beforeSend: function() {

                        },

                        error: function() {

                        },

                        success: function (activityid) {

                            var nowDate = new Date();

                            $("#u246").prepend("<div id='" + activityid  + "' class='container'>" +
                                "<hr style='top: 28px'/>" +
                                "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                "<div class='subRight'><p class='pSmall'>" + nowDate.toLocaleString() + "</p></div>" +
                                "<div class='divcenter'>" +
                                "<p class='pContent'>" + $("#u245_input").val() + "</p>" +
                                "</div>" +
                                "<hr style='top: 20px'/>" +
                                "<div class='btnDiv'>" +
                                "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                "<div class='good'><img class='goodImg' src='images/activity/good.png'></div>" +
                                "<p class='pGoodNum'>" + "<span>0</span>" + "人觉得很赞</p>" +
                                "</div>" +
                                "<div class='commentDiv'></div>" +
                                "<div class='writeCom'>" +
                                "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                "</div>");
                            $("#u245_input").val("");

                        }
                    });


                }
            });

            /*
             *
             * 加载动态并设置滚动时加载
             *
             * */
            $.ajax({
                type: "GET",

                //服务端url
                url: "activity/all/isfirst",
                dataType: "json",
                data: {
                    "lastTime": null,
                    "view": "self"
                },
                async: false,                           //可能会使得效率下降
                timeout: 5000,
                cache: false,
                beforeSend: function () {
                    //加载中...
                },
                error: function () {

                },

                //以下函数获取服务端传递给客户端的json格式数据
                success: function (res) {

                    if (res.tag === true) {
                        var userName = res.userName;
                        var activity = res.activity;
                        var comments = res.comments;
                        var commenters = res.commenters;
                        var pro = res.pro;


                        //设置赞图标的显示格式
                        var proDiv;
                        if(pro === true) {
                            proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                        } else {
                            proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                        }

                        var commentDisplay = "<div class='commentDiv'>";

                        // 组成评论的展示字符串
                        for (i in comments) {
                            commentDisplay = commentDisplay +
                                "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                "<p class='pComment'>" + comments[i].content + "</p>";
                        }
                        commentDisplay = commentDisplay + "</div>";

                        var pubDate = new Date(activity.publicdatetime);

                        $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                            "<hr style='top: 28px'/>" +
                            "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                            "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                            "<div class='divcenter'>" +
                            "<p class='pContent'>" + activity.content + "</p>" +
                            "</div>" +
                            "<hr style='top: 20px'/>" +
                            "<div class='btnDiv'>" +
                            "<div class='comment'><img src='images/activity/comment.png'></div>" +
                            "<div class='good'>" + proDiv + "</div>" +
                            "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                            "</div>" +
                            commentDisplay +
                            "<div class='writeCom'>" +
                            "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                            "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                            "</div>");

                    }

                }
            });


            for(var i = 0; i < 3; i++) {

                $.ajax({

                    type: "GET",

                    //服务端url
                    url: "activity/all/follow",
                    dataType: "json",
                    data: {
                        "lastTime": null,
                        "view": "self"
                    },
                    //async: false,                           //可能会使得效率下降
                    timeout: 5000,
                    cache: false,
                    beforeSend: function () {
                        //加载中...
                    },
                    error: function () {

                    },
                    //以下函数获取服务端传递给客户端的json格式数据
                    success: function (res) {

                        if (res.tag === true) {
                            var userName = res.userName;
                            var activity = res.activity;
                            var comments = res.comments;
                            var commenters = res.commenters;
                            var pro = res.pro;


                            //设置赞图标的显示格式
                            var proDiv;
                            if(pro === true) {
                                proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                            } else {
                                proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                            }

                            var commentDisplay = "<div class='commentDiv'>";

                            // 组成评论的展示字符串
                            for (i in comments) {
                                commentDisplay = commentDisplay +
                                    "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                    "<p class='pComment'>" + comments[i].content + "</p>";
                            }
                            commentDisplay = commentDisplay + "</div>";

                            var pubDate = new Date(activity.publicdatetime);

                            $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                                "<hr style='top: 28px'/>" +
                                "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                                "<div class='divcenter'>" +
                                "<p class='pContent'>" + activity.content + "</p>" +
                                "</div>" +
                                "<hr style='top: 20px'/>" +
                                "<div class='btnDiv'>" +
                                "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                "<div class='good'>" + proDiv + "</div>" +
                                "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                                "</div>" +
                                commentDisplay +
                                "<div class='writeCom'>" +
                                "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                "</div>");

                        }

                    }
                });
            }


            //var hasMore = true;
            $("#u227_state0").scroll(function () {

                var scrollTop = $(this).scrollTop();
                var scrollHeight = $(this).get(0).scrollHeight;
                var windowHeight = $(this).height();


                //如果有更多动态，则继续加载
                if (scrollTop / ( scrollHeight - windowHeight ) >= 0.8 && scrollTop / ( scrollHeight - windowHeight ) < 1) { //&& hasMore) {

                    $.ajax({

                        type: "GET",

                        //服务端url
                        url: "activity/all/follow",
                        dataType: "json",
                        data: {
                            "lastTime": null,
                            "view": "self"
                        },
                        //async: false,                           //可能会使得效率下降
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        //以下函数获取服务端传递给客户端的json格式数据
                        success: function (res) {

                            if (res.tag === true) {
                                var userName = res.userName;
                                var activity = res.activity;
                                var comments = res.comments;
                                var commenters = res.commenters;
                                var pro = res.pro;


                                //设置赞图标的显示格式
                                var proDiv;
                                if (pro === true) {
                                    proDiv = "<img class='goodImg' src='images/activity/good_selected.png'>";
                                } else {
                                    proDiv = "<img class='goodImg' src='images/activity/good.png'>";
                                }


                                var commentDisplay = "<div class='commentDiv'>";

                                // 组成评论的展示字符串
                                for (i in comments) {
                                    commentDisplay = commentDisplay +
                                        "<p class='pCommenter'>" + commenters[i] + "</p>" +
                                        "<p class='pComment'>" + comments[i].content + "</p>";
                                }
                                commentDisplay = commentDisplay + "</div>";

                                var pubDate = new Date(activity.publicdatetime);


                                //此处是滚动条到底部时候触发的事件，在这里写要加载的数据，或者是拉动滚动条的操作
                                $("#u246").append("<div id='" + activity.activityid + "' class='container'>" +
                                    "<hr style='top: 28px'/>" +
                                    "<div class='subLeft'><p class='pTitle'>" + userName + "</p></div>" +
                                    "<div class='subRight'><p class='pSmall'>" + pubDate.toLocaleString() + "</p></div>" +
                                    "<div class='divcenter'>" +
                                    "<p class='pContent'>" + activity.content + "</p>" +
                                    "</div>" +
                                    "<hr style='top: 20px'/>" +
                                    "<div class='btnDiv'>" +
                                    "<div class='comment'><img src='images/activity/comment.png'></div>" +
                                    "<div class='good'>" + proDiv + "</div>" +
                                    "<p class='pGoodNum'>" + "<span>" + activity.pros + "</span>" + "人觉得很赞</p>" +
                                    "</div>" +
                                    commentDisplay +
                                    "<div class='writeCom'>" +
                                    "<div class='inputcontainer'><input type='text' class='input_comment'></div>" +
                                    "<div class='submitcontainer'><button class='submit_comment'>评论</button></div>" +
                                    "</div>");

                            } //else {
                              //  hasMore = false;
                              //}

                        }
                    });

                }
            });


            /*
             *
             * 为点赞图标绑定事件
             *
             * */

            $(".good").live("click", function () {

                var activityid = $(this).parents(".container").attr("id");
                // 如果未点赞，再次点击则点赞
                // 向后台同步数据，同时使显示的的点赞数加一
                if ($(this).find("img").attr('src') === 'images/activity/good.png') {
                    $(this).find("img").attr('src', "images/activity/good_selected.png");
                    //alert(activityid);
                    // 向后台传递点赞消息
                    $.ajax({
                        type: "POST",

                        //服务端url
                        url: "activity/pro",
                        dataType: "json",
                        data: {
                            "activityid": activityid
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        success: function (){
                            var pdiv = "#" + activityid;
                            var proNum = 1 + parseInt($(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text());
                            $(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text(proNum);

                        }
                    });

                }
                // 如果已经点赞，再次点击则取消点赞
                // 向后台同步数据，同时使显示的的点赞数减一
                else {
                    $(this).find("img").attr('src', "images/activity/good.png");
                    //alert(activityid);
                    // 向后台传递取消点赞的消息
                    $.ajax({
                        type: "POST",

                        //服务端url
                        url: "activity/pro/delete",
                        dataType: "json",
                        data: {
                            "activityid": activityid
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {
                            //加载中...
                        },
                        error: function () {

                        },
                        success: function (res) {

//                            if(res.result === "ERROR")
//                                alert(res.reason);
//                            alert(res.result);

                            var pdiv = "#" + activityid;
                            var proNum = parseInt($(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text()) - 1;
                            $(pdiv).children(".btnDiv").children(".pGoodNum").children("span").text(proNum);
                        }
                    });

                }
            });

            /*
             *
             *
             *  为评论图标绑定事件
             *
             * */
            $(".comment").live("click", function () {
                if ($(this).find("img").attr('src') === 'images/activity/comment.png') {
                    $(this).find("img").attr('src', "images/activity/comment_selected.png");

                }
                else {
                    $(this).find("img").attr('src', "images/activity/comment.png");
                }
                $(this).parents(".container").children(".writeCom").toggle(200);
            });


            /*
             *
             *
             *  为评论按钮绑定事件
             *
             * */

            $(".submit_comment").live("click", function() {


                //alert($(this).text());
                var inputEle = $(this).parents(".submitcontainer").siblings(".inputcontainer").children("input");
                var input = inputEle.val();
                //alert(input);
                if(input !== "") {

                    var activityid = $(this).parents(".container").attr("id");
                    //alert(activityid);
                    //alert(input);
                    $.ajax({
                        type: "POST",

                        // 服务端url
                        // 不用contentType指定编码则会出现乱码问题
                        url: "activity/comment",
                        contentType: "application/x-www-form-urlencoded; charset=utf-8",
                        dataType: "json",
                        data: {
                            "activityid": activityid,
                            "content": input
                        },
                        timeout: 5000,
                        cache: false,
                        beforeSend: function () {

                        },
                        error: function () {

                        },
                        success: function (res) {

//                            if (res.result === "ERROR")
//                                alert(res.reason);
//                            alert(res.result);

                            var pdiv = "#" + activityid;
                            $(pdiv).children(".commentDiv").append("<p class='pCommenter'>" + userName + "</p>" +
                                "<p class='pComment'>" + input + "</p>");
                            inputEle.val("");
                            inputEle.parents(".container").children(".btnDiv").children(".comment").click();

                        }
                    });
                }
            });


        })


    </script>
</head>
<body>
<div id="base" class="">

    <!-- Unnamed (动态面板) -->
    <div id="u297" class="ax_default">
        <div id="u297_state0" class="panel_state" data-label="State1" style="">
            <div id="u297_state0_content" class="panel_state_content">

                <!-- Unnamed (矩形) -->
                <div id="u298" class="ax_default">
                    <div id="u298_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u299" class="text" style="display:none; visibility: hidden">
                        <p><span></span></p>
                    </div>
                </div>

                <!-- Unnamed (矩形) -->
                <div id="u300" class="ax_default">
                    <div id="u300_div" class=""></div>
                    <!-- Unnamed () -->
                    <div id="u301" class="text">
                        <p><span>同领英，自便……………………</span></p>
                    </div>
                </div>

                <!-- Release[submit btn] (图片) -->
                <div id="u302" class="ax_default image" data-label="Release[submit btn]">
                    <img id="u302_img" class="img " src="images/activity/release_submit_btn__u302.png"/>
                    <!-- Unnamed () -->
                    <div id="u303" class="text" style="display:none; visibility: hidden">
                        <p><span></span></p>
                    </div>
                </div>

                <!-- 动态发布 (多行文本框) -->
                <div id="u304" class="ax_default text_area" data-label="动态发布">
                    <textarea id="u304_input"></textarea>
                </div>

                <!-- Unnamed (组合) -->
                <div id="u305" class="ax_default" data-left="245" data-top="220" data-width="429" data-height="377">

                    <!-- Unnamed (矩形) -->
                    <div id="u306" class="ax_default">
                        <div id="u306_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u307" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (水平线) -->
                    <div id="u308" class="ax_default line">
                        <img id="u308_img" class="img " src="images/activity/u308.png"/>
                        <!-- Unnamed () -->
                        <div id="u309" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (水平线) -->
                    <div id="u310" class="ax_default line">
                        <img id="u310_img" class="img " src="images/activity/u308.png"/>
                        <!-- Unnamed () -->
                        <div id="u311" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (形状) -->
                    <div id="u312" class="ax_default icon">
                        <img id="u312_img" class="img " src="images/activity/u312.png"/>
                        <!-- Unnamed () -->
                        <div id="u313" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (形状) -->
                    <div id="u314" class="ax_default icon">
                        <img id="u314_img" class="img " src="images/activity/u314.png"/>
                        <!-- Unnamed () -->
                        <div id="u315" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (矩形) -->
                    <div id="u316" class="ax_default">
                        <div id="u316_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u317" class="text">
                            <p><span>武汉大学</span></p>
                        </div>
                    </div>

                    <!-- Unnamed (矩形) -->
                    <div id="u318" class="ax_default">
                        <div id="u318_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u319" class="text">
                            <p><span>xxx人觉得很赞</span></p>
                        </div>
                    </div>

                    <!-- Unnamed (图片) -->
                    <div id="u320" class="ax_default image">
                        <img id="u320_img" class="img " src="images/activity/u320.png"/>
                        <!-- Unnamed () -->
                        <div id="u321" class="text" style="display:none; visibility: hidden">
                            <p><span></span></p>
                        </div>
                    </div>

                    <!-- Unnamed (矩形) -->
                    <div id="u322" class="ax_default">
                        <div id="u322_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u323" class="text">
                            <p><span>炎炎夏日，为何街道口还有一批学子在武汉坚守</span></p>
                        </div>
                    </div>

                    <!-- Unnamed (矩形) -->
                    <div id="u324" class="ax_default">
                        <div id="u324_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u325" class="text">
                            <p><span>Gobang</span></p>
                        </div>
                    </div>

                    <!-- 发布评论 (组合) -->
                    <div id="u326" class="ax_default ax_default_hidden" data-label="发布评论"
                         style="display:none; visibility: hidden" data-left="0" data-top="0" data-width="0"
                         data-height="0">

                        <!-- Unnamed (矩形) -->
                        <div id="u327" class="ax_default">
                            <div id="u327_div" class=""></div>
                            <!-- Unnamed () -->
                            <div id="u328" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>

                        <!-- Unnamed (文本框) -->
                        <div id="u329" class="ax_default text_field">
                            <input id="u329_input" type="text" value=""/>
                        </div>

                        <!-- Unnamed (形状) -->
                        <div id="u330" class="ax_default box_1">
                            <img id="u330_img" class="img " src="images/activity/u330.png"/>
                            <!-- Unnamed () -->
                            <div id="u331" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Unnamed (矩形) -->
                    <div id="u332" class="ax_default">
                        <div id="u332_div" class=""></div>
                        <!-- Unnamed () -->
                        <div id="u333" class="text">
                            <p><span>x年x月x日&nbsp; 00:00</span></p>
                        </div>
                    </div>
                </div>

                <!-- 悬浮 (组合) -->
                <div id="u334" class="ax_default" data-label="悬浮" data-left="0" data-top="0" data-width="912"
                     data-height="280">

                    <!-- Unnamed (组合) -->
                    <div id="u335" class="ax_default" data-left="0" data-top="0" data-width="232" data-height="280">

                        <!-- Unnamed (矩形) -->
                        <div id="u336" class="ax_default">
                            <div id="u336_div" class=""></div>
                            <!-- Unnamed () -->
                            <div id="u337" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>

                        <!-- Unnamed (图片) -->
                        <div id="u338" class="ax_default">
                            <img id="u338_img" class="img " src="images/activity/u338.png"/>
                            <!-- Unnamed () -->
                            <div id="u339" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>

                        <!-- Unnamed (矩形) -->
                        <div id="u340" class="ax_default">
                            <div id="u340_div" class=""></div>
                            <!-- Unnamed () -->
                            <div id="u341" class="text">
                                <p><span>Gobang</span></p>
                            </div>
                        </div>

                        <!-- Unnamed (矩形) -->
                        <div id="u342" class="ax_default">
                            <div id="u342_div" class=""></div>
                            <!-- Unnamed () -->
                            <div id="u343" class="text">
                                <p><span>武汉大学-院系-年级</span></p>
                            </div>
                        </div>

                        <!-- Unnamed (形状) -->
                        <div id="u344" class="ax_default icon">
                            <img id="u344_img" class="img " src="images/activity/u344.png"/>
                            <!-- Unnamed () -->
                            <div id="u345" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>

                        <!-- Unnamed (水平线) -->
                        <div id="u346" class="ax_default line">
                            <img id="u346_img" class="img " src="images/activity/u346.png"/>
                            <!-- Unnamed () -->
                            <div id="u347" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>
                    </div>

                    <!-- Unnamed (组合) -->
                    <div id="u348" class="ax_default" data-left="680" data-top="0" data-width="232" data-height="280">

                        <!-- Unnamed (水平线) -->
                        <div id="u349" class="ax_default line">
                            <img id="u349_img" class="img " src="images/activity/u346.png"/>
                            <!-- Unnamed () -->
                            <div id="u350" class="text" style="display:none; visibility: hidden">
                                <p><span></span></p>
                            </div>
                        </div>

                        <!-- Unnamed (矩形) -->
                        <div id="u351" class="ax_default">
                            <div id="u351_div" class=""></div>
                            <!-- Unnamed () -->
                            <div id="u352" class="text">
                                <p><span><br></span></p>
                                <p><span><br></span></p>
                                <p><span><br></span></p>
                                <p><span>公告</span></p>
                                <p><span><br></span></p>
                                <p><span>一些奇怪的超链接</span></p>
                                <p><span><br></span></p>
                                <p><span><br></span></p>
                                <p><span><br></span></p>
                                <p><span><br></span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
